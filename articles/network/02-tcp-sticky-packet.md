# TCP 粘包

## Nagle 算法

> Nagle 算法的核心思想是允许网络中最多只能有一个小分组被发送，
> 而待发送的其它小分组会被重新分组成一个”较大的”小分组，等收到上一个小分组的应答后再发送。

优点：当传输数据存在大量交互数据时，Nagle 算法可以有效减少网络中的报文段个数。

缺点：对于实时性要求非常高的情况下，Nagle 算法会造成客户端明显的延迟，所以这种场景下需要禁用 Nagle 算法。

## 粘包问题

Nalge 算法可能造成粘包现象，但是导致粘包的根本原因在于 TCP 是基于数据流的协议，接收端提取数据以字节为单位。

而一个消息包含多个字节，接收方不知道消息之间的界限在哪里，不知道提取多少字节的数据。

无论底层怎样分段：

```
1111
1222
2233
3334
4444
```

接收端 TCP 协议层会把构成整条消息的数据段排序完成后才呈现在内核缓冲区：

```
11111222223333344444
```

因此要解决粘包问题，只需要处理消息界限即可。

## 粘包问题解决

*   方法一：指定长度，应用层协议约定前 N 个字节指定消息的长度，接收端只需要按长度读字节数据即可。
*   方法二：用结束符，应用层协议约定后 N 个字节设置为某个特定的值表示消息的结束。

例如：

```
发送端：
    先发报头长度
    再编码报头内容然后发送
    最后发真实内容

接收端：
    先收报头长度
    根据取出的长度收取报头内容，然后解码，反序列化
    从反序列化的结果中取出待取数据的详细信息，然后去取真实的数据内容
```

## 参考资料

*   [tcp 粘包问题](https://www.cnblogs.com/sui776265233/p/9289858.html)
*   [TCP/IP 学习笔记（六）Nagle 算法](https://blog.csdn.net/sinat_35261315/article/details/79392116)

